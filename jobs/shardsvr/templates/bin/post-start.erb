#!/usr/bin/env bash
set -eu
<%-
  rs_config = <<-EOCONFIG
  {
    _id : "#{p('replication.replica_set_name')}",
    members: [
      { _id: "#{spec.id}", host: "#{spec.address}:#{p('port')}" },
    ]
  }
  EOCONFIG
%>
# Intialize replicaset if needed
/var/vcap/jobs/shardsvr/bin/mongo --eval 'rs.initiate(<%= rs_config %>) || quit()'
# Add this host to replicaset if needed
/var/vcap/jobs/shardsvr/bin/mongo --eval 'rs.add( { host: "<%= spec.address %>:<%= p('port') %>", priority: 0, votes: 0 } ) || quit()'
/var/vcap/jobs/shardsvr/bin/mongos --eval 'sh.addShard("<%= p('replication.replica_set_name') %>/<%= spec.address %>:<%= p('port') %>")'

<% for user in p('users') %>
<%-
  require 'json'
  user_config = <<-EOCONFIG
  {
    user: "#{user['name']}",
    pwd: "#{user['password']}",
    roles: #{JSON.dump user['roles']}
  }
  EOCONFIG
%>
/var/vcap/jobs/shardsvr/bin/mongo <<'EOCOMMAND'
use admin
db.createUser({
  user: "<%= user['name'] %>",
  pwd: "<%= user['password'] %>",
  roles: <%= JSON.dump user['roles'] %>
})
quit()
EOCOMMAND
<% end %>